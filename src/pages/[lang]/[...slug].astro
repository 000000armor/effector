---
import { CollectionEntry, getCollection } from "astro:content";
import MainLayout from "../../layouts/MainLayout.astro";
import { getPathParamsFromId } from "../../languages";

// TODO: add breadcrumbs

export async function getStaticPaths() {
  const docs = await getCollection("docs");
  return docs.map((entry) => {
    let { lang, slug } = getPathParamsFromId(entry.id);
    if (slug.endsWith("/index")) {
      slug = slug.replace(/\/index$/, "");
    }
    return {
      params: { lang, slug },
      props: entry,
    };
  });
}

export type Props = CollectionEntry<"docs">;
const { slug, lang } = Astro.params;
const translations = (
  await getCollection("docs", (entry) => {
    const path = getPathParamsFromId(entry.id);
    // Get any other translation for current slug
    const sameSlug = path.slug === slug || `${slug}/index` === path.slug;
    if (sameSlug && path.lang !== lang) return entry;
  })
).map((entry) => {
  const path = getPathParamsFromId(entry.id);
  if (path.slug.endsWith("/index")) {
    return {
      slug: path.slug.replace(/\/index$/, ""),
      lang: path.lang,
    };
  }
  return path;
});
const post = Astro.props;
const { Content, headings } = await post.render();
---

<MainLayout headings={headings} {...post.data} translations={translations}>
  <Content />
</MainLayout>
